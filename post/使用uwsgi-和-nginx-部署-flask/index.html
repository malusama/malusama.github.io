<!DOCTYPE html>
<html lang="zh">
    
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="theme-color" content="dark">
    <title> ä½¿ç”¨uwsgi å’Œ nginx éƒ¨ç½² Flask | Malu Blog</title>
    
    
    
    <link rel="stylesheet" href="/sass/main.min.c1a012fbaa03c1e7c1ca2f1a0d3f8692dcb911bfc677b5432c7c06d2581f7de1.css">
</head>

    <body class="dark">
        <nav class="navbar">
    <div class="container">
        <div class="flex">
            <div>
                <a class="brand" href="/">
                    
                    <span class="emoji">
                        ğŸ˜
                    </span>
                    
                    Malu Blog
                    </a>
            </div>
            <div class="flex">
                
                <a href="/articles/">Articles</a>
                
                <button id="dark-mode-button"></button>
            </div>
            </div>
    </div>
</nav>
        <main>
            

<div class="container">
    <article>
        <header class="article-header">
            <div class="thumb">
                <div>
                    <h1>ä½¿ç”¨uwsgi å’Œ nginx éƒ¨ç½² Flask</h1>
                    <div class="post-meta">
                        <div>
                            By  on <time>May 01, 2018</time>
                        </div>
                        <div class="tags">
                            
                            <a href="/tags/uwsgi/">uwsgi</a>
                            
                            <a href="/tags/nginx/">nginx</a>
                            
                            <a href="/tags/flask/">Flask</a>
                            
                        </div>
                    </div>
                </div>
            </div>
        </header>
    </article>

    <div class="article-post">
    <p>â€‹	ä¹‹å‰ä½¿ç”¨äº† gunicorn æ¥éƒ¨ç½² Flask åº”ç”¨,ä½†æ˜¯æ„Ÿè§‰ nginx ä¼šä¸ä¼šæ›´å¿«ä¸€äº›, äºæ˜¯å°±æœ‰äº†å°è¯•ä½¿ç”¨ uwsgi é…åˆ nginx æ¥éƒ¨ç½² Flask çš„æƒ³æ³•.</p>
<p>â€‹	ä½†æ˜¯çœ‹äº†ä¸€äº›æ–‡ç« ä¹‹åæ„Ÿè§‰é€Ÿåº¦åº”è¯¥æ˜¯ä¸€æ ·çš„, åç«¯éƒ½æ˜¯ Python, ä½†æ˜¯æœ‰äººè¯´ Nginx æ›´å®‰å…¨. é™æ€é¡µé¢çš„æ”¯æŒä¹Ÿæ›´å¥½, æ‰€ä»¥ä¹Ÿé…ç½®ç©ä¸€ä¸‹é¡ºä¾¿æµ‹è¯•ä¸€ä¸‹é™æ€çš„å¹¶å‘é‡.</p>
<p>â€‹	é¦–å…ˆå®‰è£…uWSGI, ä½¿ç”¨pipæ¥å®‰è£…</p>
<pre><code>pip install uwsgi
</code></pre><p>åœ¨ Flask åº”ç”¨çš„ç›®å½•ä¸‹æµ‹è¯• uwsgi æ˜¯å¦å·¥ä½œ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">uwsgi --socket 0.0.0.0:8000 --protocol<span class="o">=</span>http -w run:app
</code></pre></td></tr></table>
</div>
</div><p>è¿™æ—¶å€™æ‰“å¼€ 127.0.0.1:8000 å°±å¯ä»¥çœ‹åˆ° ç½‘ç«™çš„é¦–é¡µäº†.</p>
<p>æ¥ç€æˆ‘ä»¬é…ç½®çœŸæ­£é…åˆ nginx ä½¿ç”¨çš„ uwsgi é…ç½®.</p>
<p>åœ¨ Flask åº”ç”¨ç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶ config.ini ä½œä¸ºuwsgi çš„é…ç½®æ–‡ä»¶</p>
<pre><code>[uwsgi]
master = true
wsgi-file = run.py
callable = app
chmod-socker = 777
socket =  127.0.0.1:3031
processes = 4
threads = 2
buffer-size = 32768
</code></pre><p>è¿™é‡Œ run.py æ˜¯ Flask åº”ç”¨çš„ä¸»æ–‡ä»¶, socket æ˜¯æ¥æ”¶ nginx è½¬å‘è¿‡æ¥çš„æ¥å£.</p>
<p>ä½¿ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶å¯åŠ¨ uwsgi</p>
<pre><code>uwsgi config.ini
</code></pre><p>æ¥ç€é…ç½® nginx çš„é…ç½®æ–‡ä»¶</p>
<p>nginx é»˜è®¤çš„æ˜¯ /etc/nginx/nginc.conf, é‡Œé¢ä¼šè½½å…¥ sites-enabled é‡Œçš„æ‰€æœ‰æ–‡ä»¶.</p>
<p>æ‰€ä»¥æˆ‘ä»¬åœ¨ sites-enabled æ–‡ä»¶å¤¹é‡Œæ–°å»ºä¸ªåä¸º stock.conf çš„æ–‡ä»¶,å¡«å…¥ä»¥ä¸‹å­—æ®µ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-nginx" data-lang="nginx"><span class="k">server</span> <span class="p">{</span>
	<span class="kn">listen</span> <span class="mi">80</span><span class="p">;</span>
	<span class="kn">location</span> <span class="s">/</span> <span class="p">{</span>
    	<span class="kn">include</span> <span class="s">uwsgi_params</span><span class="p">;</span>
    	<span class="kn">uwsgi_pass</span> <span class="n">127.0.0.1</span><span class="p">:</span><span class="mi">3031</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>è¿™é‡Œçš„æ„æ€æ˜¯ç›‘å¬ 80 ç«¯å£çš„ä¿¡æ¯, ä½¿ç”¨ uwsgi ä¼ é€’ç»™ 127.0.0.1:3031 è¿™ä¸ªåœ°å€, 3031æ˜¯éšä¾¿å–å¾—, å–å•¥éƒ½å¯ä»¥, æ²¡æœ‰è¢«ç³»ç»Ÿå ç”¨å°±è¡Œ.</p>
<p>é…ç½®å®Œæˆåå¯ä»¥å…ˆæ£€æŸ¥ä¸€ä¸‹é…ç½®æ–‡ä»¶æ˜¯å¦æ­£ç¡®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo nginx -t
</code></pre></td></tr></table>
</div>
</div><p>å¦‚æœæ­£ç¡®æ— è¯¯å°±å¯ä»¥å¯åŠ¨ ngxin äº†</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">sudo service nginx start
</code></pre></td></tr></table>
</div>
</div><p>æ¥ç€æ‰“å¼€ä½ çš„ç½‘å€åº”è¯¥å°±å¯ä»¥çœ‹åˆ°ç½‘ç«™çš„é¦–é¡µäº†.</p>
<p>æ¥ç€æˆ‘ç”¨ webbench -c 500 -t 60 æµ‹è¯•æœ¬åœ°çš„æœåŠ¡å™¨å¹¶å‘æ•°, ä¸€å›è½¦ CPU å°±åƒæ»¡äº†</p>
<p><img src="http://malu-picture.oss-cn-beijing.aliyuncs.com/18-5-1/23344536.jpg" alt=""></p>
<p>ä½†æ˜¯æ•ˆæœéå¸¸å¥½, æ¯”ä¹‹å‰é«˜äº†å¾ˆå¤š,</p>
<pre><code>Benchmarking: GET http://127.0.0.1/
500 clients, running 60 sec.

Speed=135661 pages/min, 1288988 bytes/sec.
Requests: 94304 susceed, 41357 failed.
</code></pre><p>å¤§çº¦ç›¸æ¯”æœ¬åœ°ä½¿ç”¨ Flask è‡ªå¸¦çš„ http server ä½¿ç”¨ Redis ç¼“å­˜æ•ˆæœé«˜äº”å€</p>
<p>æ¥ç€æµ‹è¯•æ‰“åœ¨é˜¿é‡Œäº‘ 1G1C æœåŠ¡å™¨ä¸Šçš„æ•ˆæœ</p>
<pre><code>Benchmarking: GET http://106.15.205.43/index
500 clients, running 60 sec.

Speed=4011 pages/min, 113179 bytes/sec.
Requests: 4011 susceed, 0 failed.
</code></pre><p>æ•ˆæœå¹¶æ²¡æœ‰å¥½å¤šå°‘&hellip;ä¸è¿‡çœ‹äº†113179 bytes/sec.å¤§çº¦ä¹Ÿè·‘æ»¡äº†1mçš„å¸¦å®½äº†&hellip;éš¾é“çœŸçš„æ˜¯æˆ‘çš„æœåŠ¡å™¨å¸¦å®½é™åˆ¶äº†???</p>
<p>åœ¨ä»˜äº†ä¸¤å—é’±ä¸´æ—¶å‡çº§3ä¸ªå°æ—¶åˆ°10Må¸¦å®½åå†è¿›è¡Œæµ‹è¯•ä¸€ä¸‹.</p>
<p>å…ˆæµ‹é€Ÿä¸€ä¸‹</p>
<pre><code>Retrieving speedtest.net configuration...
Testing from CNISP-Union Technology (Beijing) Co. (106.15.205.43)...
Retrieving speedtest.net server list...
Selecting best server based on ping...
Hosted by China Telecom ZheJiang Branch (Hangzhou) [4.87 km]: 6.874 ms
Testing download speed................................................................................
Download: 324.60 Mbit/s
Testing upload speed................................................................................................
Upload: 9.36 Mbit/s
</code></pre><p>ä¸é”™, é˜¿é‡Œäº‘å¥½åƒæ˜¯å¸¦å®½é™åˆ¶çš„æ˜¯ä¸Šä¼ çš„, ä¸‹è½½èƒ½é£™åˆ° 300 M. æµ‹è¯•å‰æ‰“å¼€topæŸ¥çœ‹cpuå ç”¨</p>
<pre><code>top - 23:04:20 up 3 days,  4:32,  2 users,  load average: 1.81, 0.44, 0.14
Tasks:  96 total,   4 running,  92 sleeping,   0 stopped,   0 zombie
%Cpu(s): 77.7 us, 14.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  8.0 si,  0.0 st
KiB Mem :  2052568 total,  1291168 free,   161252 used,   600148 buff/cache
KiB Swap:        0 total,        0 free,        0 used.  1693260 avail Mem 
</code></pre><p>å°é¸¡ CPU è·‘åˆ° 70å¤š&hellip;</p>
<pre><code>Benchmarking: GET http://106.15.205.43/index
500 clients, running 60 sec.

Speed=43731 pages/min, 1123486 bytes/sec.
Requests: 42446 susceed, 1285 failed.
</code></pre><p>å¥½äº†, æ•°æ®ç¡®å®å¤šäº†10å€&hellip;çœ‹æ¥ç¡®å®æ˜¯å¸¦å®½é™åˆ¶äº†. å°é¸¡ CPU ä¹Ÿä¸æ€ä¹ˆå—å¾—äº†.</p>

    </div>
</div>

<div class="container">
    
    <nav class="flex container suggested">
        
        <a rel="prev" href="/post/%E7%BB%99%E5%90%8E%E7%AB%AF%E6%B7%BB%E5%8A%A0redis%E7%BC%93%E5%AD%98/" title="Previous post (older)">
            <span>Previous</span>
            ç»™åç«¯æ·»åŠ redisç¼“å­˜
            </a>
        
        
        
        <a rel="next" href="/post/%E7%BB%99%E7%BD%91%E7%AB%99%E6%B7%BB%E5%8A%A0https/" title="Next post (newer)">
            <span>Next</span>
            ç»™ç½‘ç«™æ·»åŠ https
            </a> 
        
    </nav>
    
</div>
</main>


        </main>
        <footer class="footer flex">
    <section class="container">
        <nav class="footer-links">
            
            <a href="/index.xml">RSS</a>
            
        </nav>
    </section>
    
    <script async src="/js/features.min.a94f58a30ad2560de728e080d87f75c60cf806fd1b3d5f4815f1a1a02c0d1859.js"></script>
</footer>
    </body>
</html>