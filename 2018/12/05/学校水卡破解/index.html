<!doctype html>
<html lang="chinese">
  <head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

  
  
  

  <link rel="stylesheet" href="/css/mobi.css-3.0.4/dist/mobi.min.css">
<link rel="stylesheet" href="/css/caomei1.2.1/style.css">
<link rel="stylesheet" href="/css/theme.css">

  
    <meta name="keywords" content="IC卡，破解">
  

  

  
    <link rel="shortcut icon" href="/favicon.ico">
  

  <title>学校水卡破解 - Malu blog</title>
  <script data-ad-client="ca-pub-4390654727225048" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?196bdd0c9837159f8e291ef5a93aef95";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-4390654727225048",
        enable_page_level_ads: true
      });
    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  
      ga('create', 'UA-28923877-1', 'auto');
      ga('send', 'pageview');
    </script>
</head>

  <body class="theme-body">
    <div class="flex-center theme-header-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    <a href="/" class="unit-0 theme-header-icon theme-icon-link" title="Home">
      <i class="czs-home-l"></i>
    </a>
    <div class="flex-center text-center flex-middle unit theme-header-title theme-header-title-no-transition">
      Malu blog
    </div>
    <a class="unit-0 theme-header-icon theme-icon-link theme-header-sidebar-icon" href="javascript:void(0);" title="More">
      <i class="czs-menu-l"></i>
    </a>
  </div>
</div>
<div class="theme-header-placeholder"></div>

    <div class="flex-center">
      <div class="container">
        <article>
  <h1 class="text-center">
    学校水卡破解
  </h1>
  <div class="text-center top-gap">
    <div class="text-small text-muted">
  <time datetime="2018-12-05T23:06:18+08:00">
    2018-12-05
  </time>
  <span class="theme-separator">·</span>
  <i class="czs-user-l"></i>
  <a class="text-muted theme-text-no-decoration" href="https://github.com/"></a>
  <span class="theme-separator">·</span>
  <i class="czs-bookmark-l"></i>
  
  <span class="theme-comment-count-container theme-hide theme-comment-count-container-transparent">
    <span class="theme-separator">·</span>
    <a class="text-muted theme-text-no-decoration" href="/2018/12/05/学校水卡破解/#disqus_thread">
      <i class="czs-comment-l"></i>
      <span class="disqus-comment-count theme-comment-count" data-disqus-identifier="2018/12/05/学校水卡破解/"></span>
    </a>
  </span>
</div>

  </div>
  <div class="top-gap-big">
    <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>今天淘宝买的pn523 终于到了，话不多说，鼓捣起来。</p>


<p><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/pn532.jpg?x-oss-process=style/blog" alt></p>
<p>先下载pn523的驱动，然后配套的软件也都有界面，方便很多</p>
<p>放上店家赠送的白卡读取看下是否正常，一切正常</p>
<h3 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h3><p>目前使用非接触式卡有ID (Identification Card) 和IC(Integrated Circuit Card)的区别。</p>
<p>ID卡明文记录信息，大部分是出厂就设置好的卡号。</p>
<p>ID卡目前差不多都绝迹了，因为特别容易复制。把卡号读取出来在写入新卡就行了。</p>
<p>目前最广泛接受的是 Mifare 卡。下文称M1 卡。</p>
<blockquote>
<p>M1卡分为16个扇区，每个扇区对应4块（块0-块3）,共64块，编号为0-63.第0扇区的第0块用于存放厂商代码，已经固化无法更改。其余区的第0-2块用于存放数据，块3为控制块用于存放密码A、存取控制、密码B，结构如下：</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> A0 A1 A2 A3 A4 A5     FF 07 80 69      B0 B1 B2 B3 B4 B5</span><br><span class="line"></span><br><span class="line">(密码A 6字节)           (存储控制 4字节)   (密码B 6字节)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>并且每个扇区块3中的密码和存储控制全部都是独立的，独立控制本扇区的各种操作，每个扇区都能实现不同的功能，所以广泛用作一卡通。存储控制里面4字节的具体含义我也不是很清楚(不影响我们破解)，所以就不说出来误导大家了。</p>
</blockquote>
<p>卡中每个块包含16字节，所以M1卡的容量=16扇区<em>4块</em>16字节=1024字节=1k  (M1卡的由来)。</p>
<h3 id="鼓捣过程"><a href="#鼓捣过程" class="headerlink" title="鼓捣过程"></a>鼓捣过程</h3><p>先是拿宿舍楼的饮水卡尝试复制一下。直接读取UID卡信息，读取完后会储存为dump文件。</p>
<p>用写入功能写到一张空白卡里。这里我用到一张CUID卡，这张卡甚至可以写0扇区。</p>
<p>有些机器会验证0扇区的信息是不是自己厂家的卡，这时候CUID就起到作用了。</p>
<p>不过这种卡理论上是不应该流出的。不过目前淘宝还能买到，且玩且珍惜把。</p>
<p><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/cuid.jpg?x-oss-process=style/blog" alt></p>
<p>如果要尝试修改扇区信息，得破解 M1 卡的各个扇区的KEY A和KEY B。</p>
<p>这部分软件自动完成。大抵是穷举或者重放攻击，只有算出扇区的KEY A和KEY B才能修改。</p>
<p>在机器上查询到卡内余额后，尝试修改余额信息。这张水卡只有第八扇区有信息。我们只需要看这部分就行<br><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/17.39.jpg?x-oss-process=style/blog" alt></p>
<p>17.77<br><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/17.77.png?x-oss-process=style/blog" alt></p>
<p>发现卡内0和2块内信息是相同的。且N2和N3就是余额信息</p>
<p>因为卡内的数据都是二进制储存的，软件为了便于显示转换为16进制</p>
<p>DEC 1777 == HEX  06FF.<br>在0 区块下  我除了 N2和N3其他都不知道是什么。</p>
<blockquote>
<p>0B FA <strong>F1 06</strong> 03 03 00 00 0 00 02 00 00 02 00 02</p>
</blockquote>
<p>在尝试只修改N2和N3块后发现并不能通过验证。应该是有效验位。</p>
<p>于是我尝试读取不同余额下的第八扇区信息查看修改了什么内容。</p>
<p>17.74<br><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/17.74.png?x-oss-process=style/blog" alt></p>
<table>
<thead>
<tr>
<th></th>
<th>N0</th>
<th>N1</th>
<th>N2</th>
<th>N3</th>
<th>N4</th>
<th>N5</th>
<th>N6</th>
<th>N7</th>
<th>N8</th>
<th>N9</th>
<th>N10</th>
<th>N11</th>
<th>N12</th>
<th>N13</th>
<th>N14</th>
<th>N15</th>
</tr>
</thead>
<tbody><tr>
<td>修改前</td>
<td>0B</td>
<td>FA</td>
<td>F1</td>
<td>06</td>
<td>03</td>
<td>05</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>02</td>
<td>00</td>
<td>00</td>
<td>02</td>
<td>00</td>
<td>02</td>
</tr>
<tr>
<td>修改后</td>
<td>14</td>
<td>F7</td>
<td>EE</td>
<td>06</td>
<td>03</td>
<td>08</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>00</td>
<td>02</td>
<td>00</td>
<td>00</td>
<td>02</td>
<td>00</td>
<td>05</td>
</tr>
</tbody></table>
<p>到这里发现N4 和N10, N13  在余额变更之后它们是不变的。</p>
<p>N1， N5， N15都和余额的差值有关。<br>M1卡在记录金额时现在厂家都添加效验位，防止我这样心怀不轨的人修改余额。</p>
<p>但是大部分的验证都是XOR，和截断，或者取反。</p>
<p>再多增加几个样本看看之前的推断是否一至</p>
<p>17.68<br><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/17.68.png?x-oss-process=style/blog" alt></p>
<p>找了一张别的卡。<br><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/card.png?x-oss-process=style/blog" alt></p>
<p>经过一段时间的尝试，</p>
<blockquote>
<p>N5 = ~(N2 + N3 + N4)</p>
</blockquote>
<blockquote>
<p>N1 = ~N5</p>
</blockquote>
<blockquote>
<p>N0 = N1 xor N2 xor N2 xor N4 xor N5 </p>
</blockquote>
<blockquote>
<p>N15  = N5 - N4</p>
</blockquote>
<p>这尝试的过程太心酸，别问，掉头发。</p>
<p>在机器上测试，也验证通过</p>
<p><img src="https://blog-malu.oss-cn-beijing.aliyuncs.com/99.99%E5%85%83.jpg?x-oss-process=style/blog" alt></p>
<p>好了，至此这张卡完全破解完成了。。</p>
<p>顺带说一句。目前学校里都在使用这种卡，洗澡卡，洗衣卡，水卡，还有学生卡。<br>因为一张卡有15个扇区可写，如果这些卡的记录数据的扇区不同是可以用一张白卡把信息写上去<br>然后就可以多卡合一了。</p>

  </div>
</article>
<blockquote class="top-gap-big"> <p> 本文遵循 <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" class"text-muted">CC BY-ND-ND 3.0</a> 协议，转载请注明原作者，禁止商用，禁止演绎。 </p> </blockquote>
<div class="top-gap-big text-center text-muted">
  <small>
    <i class="czs-tag-l"></i>
    <a class="text-muted" href="/tags/IC卡，破解/">IC卡，破解</a>
  </small>
</div>


  <div id="disqus_thread" class="top-gap-big"></div>
  <script>
    var langMap = {
      en: 'en',
      'zh-CN': 'zh'
    };
    var disqus_config = function () {
      this.language = langMap['chinese'] || langMap['en'];
      this.page.url = 'http://malu.moe/2018/12/05/学校水卡破解/';
      this.page.identifier = '2018/12/05/学校水卡破解/';
      this.page.title = '学校水卡破解';
    };
    (function() {
      var d = document, s = d.createElement('script');
      s.src = '//malusama.disqus.com/embed.js';
      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


        <hr class="top-gap-big"></hr>
<p class="text-center">
  <small class="text-muted">
    &copy;
    
      2012 -
    
    <span itemprop="copyrightYear">2020</span>
    <i class="czs-heart" style="color:red;"></i>
    <span itemprop="copyrightHolder">malu</span>

    <br/>

    Powered by <a class="text-muted" href="https://hexo.io" title="Hexo">Hexo</a>
    <span class="theme-separator">·</span>
    Theme
    <a class="text-muted" href="https://github.com/xcatliu/hexo-theme-milk">Milk</a>
  </small>
</p>

      </div>
      <div class="theme-sidebar-mask theme-hide"></div>
<aside class="theme-sidebar-wrapper">
  <div class="container flex-left units-gap theme-header-container">
    
    <a class="unit-0 theme-icon-link" href="/archives" title="归档">
      <i class="czs-folder-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/categories" title="分类">
      <i class="czs-bookmark-l"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="/tags" title="标签">
      <i class="czs-tag-l"></i>
    </a>
  
    <div class="unit"></div>
  
    <a class="unit-0 theme-icon-link" href="http://malu.moe" title="关于我">
      <i class="czs-user-l"></i>
    </a>
  

  </div>
  <div class="container">
    
          <h2>Malu blog</h2>
          
          <p class="top-gap-0 text-muted"></p>
          
          <div class="flex-left flex-middle top-gap">
            <img alt="Avatar" height="24" src="/assets/about/favicon.ico"/>
            <span class="theme-sidebar-author">malu</span>
          </div>
          
          <p>欢迎访问Malusama的博客，这里搜集了我的技术文章和生活感悟，希望能够与您一起交流，共同成长。</p>
          
          <p class="theme-sidebar-social">
            
    <a class="unit-0 theme-icon-link" href="https://github.com/malusama" title="GitHub">
      <i class="czs-github"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="https://www.v2ex.com/member/malusama" title="V2EX">
      <i class="czs-v2ex"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="https://twitter.com/791644947" title="Twitter">
      <i class="czs-twitter"></i>
    </a>
  
    <a class="unit-0 theme-icon-link" href="mailto:chensichengmalu@gmail.com" title="Gmail">
      <i class="czs-message-l"></i>
    </a>
  

          </p>
          
          <h5>Links</h5>
          <p class="text-muted">
            <small>
              <ul class="theme-list-style-none">
                <li><a class="text-muted" href="https://github.com/malusama">github</a></li>
              </ul>
            </small>
          </p>
          
  </div>
</aside>

    </div>
    <script src="/js/theme.js"></script>
    
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-28923877-1', 'auto');
    ga('send', 'pageview');
  </script>


    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?196bdd0c9837159f8e291ef5a93aef95";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>



    
  <script id="dsq-count-scr" src="//malusama.disqus.com/count.js" async></script>

  </body>
</html>
